---
title: "2021 NPBC Survey"
output: html_notebook
---

```{r, message=FALSE}
# load packages
library(dplyr)
library(knitr)
library(anytime)
library(lubridate)
library(stringr)

# load data
dat <- read.csv("C:\\Users\\vthompkins.CRJ\\Documents\\GitHub\\NPBC\\responses 6-5-21.csv")
```

```{r}
# clean

# remove extra characters from var names
names(dat) <- gsub("X\\.", "", names(dat))
names(dat) <- gsub("\\.*$", "", names(dat))
names(dat)[1] <- "Response.ID"

# create flags for full dataset
d <- dat %>%
  # convert dates
  mutate_at(vars(Start.Date..UTC, Submit.Date..UTC), as.POSIXct, format = "%m/%d/%Y %H:%M") %>%
         # create time to complete survey variable
  mutate(Time.to.Complete = as.numeric(difftime(Submit.Date..UTC, Start.Date..UTC, units = "mins")),
         # create dupe flag (looks at everything but response ID, and start/submit times)
         # other items removed are text fields, contact, demographics
         Dupe.Response = duplicated(dat[, c(2:3, 9:34, 90:91, 95:120, 177:178, 184:209)]),
         # see if police was listed as first priority
         Priority.Police = if_else(str_detect(Rank.the.following.existing.and.potential.city.services.based.on.importance.from.1.to.10..._1...most.important...10...least.important_, "^Police"), 1, 0),
         # see if funding for police is same
         Full.Funding.Police = if_else(What.percentage.of.the.General.Fund.should.the.city.give.to.the.Metro.Nashville.Police.Department..MNPD == "*20%* ($213.5 million) _(current amount)_", 1, 0),
         # see if funding for sheriff is same
         Full.Funding.Sheriff = if_else(What.percentage.of.the.General.Fund.should.the.city.give.to.the.Davidson.County.Sheriff.s.Office..DCSO...which.operates.the.city.s.jails == "*7.5%* ($79.9 million) _(current amount)_",  1, 0))

# create data set of english responses
dat_eng <- dat %>%
  select(c(1:89, 263:265)) %>%
  # convert dates
  mutate_at(vars(Start.Date..UTC, Submit.Date..UTC), as.POSIXct, format = "%m/%d/%Y %H:%M") %>%
         # create time to complete survey variable
  mutate(Time.to.Complete = as.numeric(difftime(Submit.Date..UTC, Start.Date..UTC, units = "mins")),
         # create dupe flag (looks at everything but response ID, and start/submit times)
         # other items removed are text fields, contact, demographics
         Dupe.Response = duplicated(dat[, c(2:3, 9:35)]),
         # see if police was listed as first priority
         Priority.Police = if_else(str_detect(Rank.the.following.existing.and.potential.city.services.based.on.importance.from.1.to.10..._1...most.important...10...least.important_, "^Police"), 1, 0),
         # see if funding for police is same
         Full.Funding.Police = if_else(What.percentage.of.the.General.Fund.should.the.city.give.to.the.Metro.Nashville.Police.Department..MNPD == "*20%* ($213.5 million) _(current amount)_", 1, 0),
         # see if funding for sheriff is same
         Full.Funding.Sheriff = if_else(What.percentage.of.the.General.Fund.should.the.city.give.to.the.Davidson.County.Sheriff.s.Office..DCSO...which.operates.the.city.s.jails == "*7.5%* ($79.9 million) _(current amount)_",  1, 0))


# create data set of spanish responses



# create data set of arabic responses
```


```{r}
out <- d %>%
  # group by network ID
  group_by(Network.ID) %>%
            # count duplicates
  summarise(Davidson_Resident = if_else(sum(na.omit(Are.you.a.resident.of.Davidson.County)) > 0, 1, 0),
    Count.Network.IDs = n(),
    # calculate avg time to complete
    Avg.Time = round(mean(Time.to.Complete), digits = 0),
    # count of dupes
    Dupes = sum(Dupe.Response),
    # collapse police & sheriff flags
    Priority.Police = if_else(sum(Priority.Police) > 0, "Yes", "No"),
    Full.Funding.Police = if_else(sum(Full.Funding.Police) > 0, "Yes", "No"),
    Full.Funding.Sheriff = if_else(sum(Full.Funding.Sheriff) > 0, "Yes", "No")) %>%
  arrange(desc(Count.Network.IDs))


write.csv(out, file = "2021 NPBC Survey Calcs_All Final.csv", row.names = FALSE)
```
